{% extends 'berlin.lod.basetheme/dataset.html.jinja' %}
{% import 'berlin.lod.vocabtheme/voc_helper.html.jinja' as voc_helper with context %}

{% block content%}

  {{ super() }}

  <div class="row">
    {% block term_lists %}

      {% block org_list %}
        {% set org_query = '''
SELECT ?label ?org ?type ?abbreviation ?parent_label ?parent_abbreviation ?sort_key
WHERE {
    ?org 
        a ?type ;
        rdfs:label ?label ;
    .

    ?type rdfs:subClassOf* org:Organization .

    OPTIONAL {
        ?org org:unitOf/rdfs:label ?parent_label .
    }
    OPTIONAL {
        ?org org:unitOf/berorgs:abbreviation ?parent_abbreviation .
    }
    OPTIONAL {
        ?org berorgs:abbreviation ?abbreviation
    }

    # keep only the most specific type(s)
    FILTER NOT EXISTS {
        ?org a ?otherType .
        ?type rdfs:subClassOf+ ?otherType .
    }

    BIND(STR(CONCAT(COALESCE(?parent_label, ""), ?label)) AS ?raw_key)
    BIND(
        REPLACE(
            REPLACE(
                REPLACE(
                    REPLACE(
                        REPLACE(
                            REPLACE(
                                REPLACE(
                                    REPLACE(?raw_key,
                                    " I ",   " 1 "),
                                " II ",  " 2 "),
                            " III ", " 3 "),
                        " IV ",  " 4 "),
                    " V ",   " 5 "),
                " VI ",  " 6 "),
            " VII ", " 7 "),
        " VIII ", " 8 ") AS ?sort_key
    )    

}
ORDER BY ?sort_key
        '''%}

        {% set results = node | sparql_query(org_query) %}
        {% if results %}
            <div class="col-lg-4">
              {{ voc_helper.term_list(results, title="Organisationen", description="Welche Organisationen sind in diesem Datensatz enthalten?", term_var='org', title_languages=['de'])}}
            </div>
        {% endif %}
      {% endblock org_list %}

    {% endblock term_lists %}
  </div>


{% endblock content %}

